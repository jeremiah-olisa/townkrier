<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - TownKrier Dashboard</title>
  <%- include('../partials/styles') %>
</head>
<body>
  <%- include('../partials/header', {page, basePath}) %>
  
<div class="section">
  <div class="section-header">
    <h2>Job Details</h2>
    <div class="btn-group">
      <a href="<%= basePath %>/jobs" class="btn btn-primary">Back to Jobs</a>
      <% if (job.status === 'failed') { %>
        <button class="btn btn-success" onclick="retryJob()">Retry Job</button>
      <% } %>
      <button class="btn btn-danger" onclick="deleteJob()">Delete Job</button>
    </div>
  </div>

  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
    <div>
      <strong style="color: #7f8c8d; font-size: 13px;">Job ID</strong>
      <p style="margin-top: 4px; font-family: monospace;"><%= job.id %></p>
    </div>
    <div>
      <strong style="color: #7f8c8d; font-size: 13px;">Status</strong>
      <p style="margin-top: 4px;">
        <span class="status-badge status-<%= job.status %>"><%= job.status %></span>
      </p>
    </div>
    <div>
      <strong style="color: #7f8c8d; font-size: 13px;">Priority</strong>
      <p style="margin-top: 4px;"><%= job.priority %></p>
    </div>
    <div>
      <strong style="color: #7f8c8d; font-size: 13px;">Attempts</strong>
      <p style="margin-top: 4px;"><%= job.attempts %> / <%= job.maxRetries %></p>
    </div>
    <div>
      <strong style="color: #7f8c8d; font-size: 13px;">Created At</strong>
      <p style="margin-top: 4px;" class="timestamp"><%= new Date(job.createdAt).toLocaleString() %></p>
    </div>
    <% if (job.scheduledFor) { %>
      <div>
        <strong style="color: #7f8c8d; font-size: 13px;">Scheduled For</strong>
        <p style="margin-top: 4px;" class="timestamp"><%= new Date(job.scheduledFor).toLocaleString() %></p>
      </div>
    <% } %>
    <% if (job.completedAt) { %>
      <div>
        <strong style="color: #7f8c8d; font-size: 13px;">Completed At</strong>
        <p style="margin-top: 4px;" class="timestamp"><%= new Date(job.completedAt).toLocaleString() %></p>
      </div>
    <% } %>
    <% if (job.failedAt) { %>
      <div>
        <strong style="color: #7f8c8d; font-size: 13px;">Failed At</strong>
        <p style="margin-top: 4px;" class="timestamp"><%= new Date(job.failedAt).toLocaleString() %></p>
      </div>
    <% } %>
  </div>

  <% if (job.error) { %>
    <div class="alert alert-error">
      <strong>Error Message:</strong><br>
      <%= job.error %>
    </div>
  <% } %>
</div>

<div class="section">
  <h2 style="margin-bottom: 16px;">Notification Details</h2>
  
  <div style="margin-bottom: 16px;">
    <strong style="color: #7f8c8d; font-size: 13px;">Notification Type</strong>
    <p style="margin-top: 4px;"><%= job.notification.constructor.name %></p>
  </div>

  <div style="margin-bottom: 16px;">
    <strong style="color: #7f8c8d; font-size: 13px;">Channels</strong>
    <p style="margin-top: 4px;"><%= job.notification.via().join(', ') %></p>
  </div>

  <div>
    <strong style="color: #7f8c8d; font-size: 13px;">Recipient Information</strong>
    <div class="code-block" style="margin-top: 8px;">
      <%= JSON.stringify(job.recipient, null, 2) %>
    </div>
  </div>
</div>

<div class="section">
  <h2 style="margin-bottom: 16px;">Execution Logs</h2>
  
  <% if (job.logs.length === 0) { %>
    <div class="empty-state">
      <div class="empty-state-icon">ðŸ“‹</div>
      <h3>No logs available</h3>
    </div>
  <% } else { %>
    <table>
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Attempt</th>
          <th>Status</th>
          <th>Message</th>
          <th>Duration</th>
        </tr>
      </thead>
      <tbody>
        <% job.logs.forEach(log => { %>
          <tr>
            <td class="timestamp"><%= new Date(log.timestamp).toLocaleString() %></td>
            <td><%= log.attempt %></td>
            <td>
              <span class="status-badge status-<%= log.status %>"><%= log.status %></span>
            </td>
            <td>
              <%= log.message %>
              <% if (log.error) { %>
                <br><span style="color: #e74c3c; font-size: 12px;"><%= log.error %></span>
              <% } %>
            </td>
            <td><%= log.duration ? log.duration + 'ms' : '-' %></td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  <% } %>
</div>

<% if (job.metadata) { %>
  <div class="section">
    <h2 style="margin-bottom: 16px;">Metadata</h2>
    <div class="code-block">
      <%= JSON.stringify(job.metadata, null, 2) %>
    </div>
  </div>
<% } %>

<script>
  const basePath = '<%= basePath %>';
  const jobId = '<%= job.id %>';
  
  async function retryJob() {
    if (!confirm('Retry this job?')) return;
    
    try {
      const response = await fetch(`${basePath}/api/jobs/${jobId}/retry`, { method: 'POST' });
      if (response.ok) {
        alert('Job queued for retry');
        location.reload();
      } else {
        alert('Failed to retry job');
      }
    } catch (error) {
      console.error('Failed to retry job:', error);
      alert('Failed to retry job');
    }
  }

  async function deleteJob() {
    if (!confirm('Are you sure you want to delete this job?')) return;
    
    try {
      const response = await fetch(`${basePath}/api/jobs/${jobId}`, { method: 'DELETE' });
      if (response.ok) {
        alert('Job deleted');
        location.href = `${basePath}/jobs`;
      } else {
        alert('Failed to delete job');
      }
    } catch (error) {
      console.error('Failed to delete job:', error);
      alert('Failed to delete job');
    }
  }
</script>

  
  <%- include('../partials/footer') %>
</body>
</html>